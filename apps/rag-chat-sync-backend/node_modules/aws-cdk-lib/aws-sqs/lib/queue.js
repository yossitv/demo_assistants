"use strict";var __esDecorate=exports&&exports.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(f!==void 0&&typeof f!="function")throw new TypeError("Function expected");return f}for(var kind=contextIn.kind,key=kind==="getter"?"get":kind==="setter"?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),_,done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]=p==="access"?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])(kind==="accessor"?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if(kind==="accessor"){if(result===void 0)continue;if(result===null||typeof result!="object")throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&(kind==="field"?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0},__runInitializers=exports&&exports.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Queue=exports.RedrivePermission=exports.FifoThroughputLimit=exports.DeduplicationScope=void 0;var jsiiDeprecationWarnings=()=>{var tmp=require("../../.warnings.jsii.js");return jsiiDeprecationWarnings=()=>tmp,tmp};const JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti");var queue_base_1=()=>{var tmp=require("./queue-base");return queue_base_1=()=>tmp,tmp},sqs_generated_1=()=>{var tmp=require("./sqs.generated");return sqs_generated_1=()=>tmp,tmp},validate_queue_props_1=()=>{var tmp=require("./validate-queue-props");return validate_queue_props_1=()=>tmp,tmp},iam=()=>{var tmp=require("../../aws-iam");return iam=()=>tmp,tmp},kms=()=>{var tmp=require("../../aws-kms");return kms=()=>tmp,tmp},core_1=()=>{var tmp=require("../../core");return core_1=()=>tmp,tmp},errors_1=()=>{var tmp=require("../../core/lib/errors");return errors_1=()=>tmp,tmp},metadata_resource_1=()=>{var tmp=require("../../core/lib/metadata-resource");return metadata_resource_1=()=>tmp,tmp},prop_injectable_1=()=>{var tmp=require("../../core/lib/prop-injectable");return prop_injectable_1=()=>tmp,tmp},DeduplicationScope;(function(DeduplicationScope2){DeduplicationScope2.MESSAGE_GROUP="messageGroup",DeduplicationScope2.QUEUE="queue"})(DeduplicationScope||(exports.DeduplicationScope=DeduplicationScope={}));var FifoThroughputLimit;(function(FifoThroughputLimit2){FifoThroughputLimit2.PER_QUEUE="perQueue",FifoThroughputLimit2.PER_MESSAGE_GROUP_ID="perMessageGroupId"})(FifoThroughputLimit||(exports.FifoThroughputLimit=FifoThroughputLimit={}));var RedrivePermission;(function(RedrivePermission2){RedrivePermission2.ALLOW_ALL="allowAll",RedrivePermission2.DENY_ALL="denyAll",RedrivePermission2.BY_QUEUE="byQueue"})(RedrivePermission||(exports.RedrivePermission=RedrivePermission={}));let Queue=(()=>{let _classDecorators=[prop_injectable_1().propertyInjectable],_classDescriptor,_classExtraInitializers=[],_classThis,_classSuper=queue_base_1().QueueBase;var Queue2=class extends _classSuper{static{_classThis=this}static{const _metadata=typeof Symbol=="function"&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;__esDecorate(null,_classDescriptor={value:_classThis},_classDecorators,{kind:"class",name:_classThis.name,metadata:_metadata},null,_classExtraInitializers),Queue2=_classThis=_classDescriptor.value,_metadata&&Object.defineProperty(_classThis,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static[JSII_RTTI_SYMBOL_1]={fqn:"aws-cdk-lib.aws_sqs.Queue",version:"2.230.0"};static PROPERTY_INJECTION_ID="aws-cdk-lib.aws-sqs.Queue";static fromQueueArn(scope,id,queueArn){return Queue2.fromQueueAttributes(scope,id,{queueArn})}static fromQueueAttributes(scope,id,attrs){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_sqs_QueueAttributes(attrs)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.fromQueueAttributes),error}const stack=core_1().Stack.of(scope),parsedArn=stack.splitArn(attrs.queueArn,core_1().ArnFormat.NO_RESOURCE_NAME),queueName=attrs.queueName||parsedArn.resource,queueUrl=attrs.queueUrl||`https://sqs.${parsedArn.region}.${stack.urlSuffix}/${parsedArn.account}/${queueName}`;class Import extends queue_base_1().QueueBase{queueArn=attrs.queueArn;queueUrl=queueUrl;queueName=queueName;encryptionMasterKey=attrs.keyArn?kms().Key.fromKeyArn(this,"Key",attrs.keyArn):void 0;fifo=this.determineFifo();encryptionType=attrs.keyArn?queue_base_1().QueueEncryption.KMS:void 0;autoCreatePolicy=!1;determineFifo(){if(core_1().Token.isUnresolved(this.queueArn))return attrs.fifo||!1;if(typeof attrs.fifo<"u"){if(attrs.fifo&&!queueName.endsWith(".fifo"))throw new(errors_1()).ValidationError("FIFO queue names must end in '.fifo'",this);if(!attrs.fifo&&queueName.endsWith(".fifo"))throw new(errors_1()).ValidationError("Non-FIFO queue name may not end in '.fifo'",this)}return!!queueName.endsWith(".fifo")}}return new Import(scope,id,{environmentFromArn:attrs.queueArn})}queueArn;queueName;queueUrl;encryptionMasterKey;fifo;encryptionType;deadLetterQueue;autoCreatePolicy=!0;constructor(scope,id,props={}){super(scope,id,{physicalName:props.queueName});try{jsiiDeprecationWarnings().aws_cdk_lib_aws_sqs_QueueProps(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,Queue2),error}(0,metadata_resource_1().addConstructMetadata)(this,props),(0,validate_queue_props_1().validateQueueProps)(this,props),props.redriveAllowPolicy&&(0,validate_queue_props_1().validateRedriveAllowPolicy)(this,props.redriveAllowPolicy);const redrivePolicy=props.deadLetterQueue?{deadLetterTargetArn:props.deadLetterQueue.queue.queueArn,maxReceiveCount:props.deadLetterQueue.maxReceiveCount}:void 0,redriveAllowPolicy=props.redriveAllowPolicy?{redrivePermission:props.redriveAllowPolicy.redrivePermission??(props.redriveAllowPolicy.sourceQueues?RedrivePermission.BY_QUEUE:RedrivePermission.ALLOW_ALL),sourceQueueArns:props.redriveAllowPolicy.sourceQueues?.map(q=>q.queueArn)}:void 0,{encryptionMasterKey,encryptionProps,encryptionType}=_determineEncryptionProps.call(this),fifoProps=this.determineFifoProps(props);this.fifo=fifoProps.fifoQueue||!1;const queue=new(sqs_generated_1()).CfnQueue(this,"Resource",{queueName:this.physicalName,...fifoProps,...encryptionProps,redrivePolicy,redriveAllowPolicy,delaySeconds:props.deliveryDelay&&props.deliveryDelay.toSeconds(),maximumMessageSize:props.maxMessageSizeBytes,messageRetentionPeriod:props.retentionPeriod&&props.retentionPeriod.toSeconds(),receiveMessageWaitTimeSeconds:props.receiveMessageWaitTime&&props.receiveMessageWaitTime.toSeconds(),visibilityTimeout:props.visibilityTimeout&&props.visibilityTimeout.toSeconds()});queue.applyRemovalPolicy(props.removalPolicy??core_1().RemovalPolicy.DESTROY),this.queueArn=this.getResourceArnAttribute(queue.attrArn,{service:"sqs",resource:this.physicalName}),this.queueName=this.getResourceNameAttribute(queue.attrQueueName),this.encryptionMasterKey=encryptionMasterKey,this.queueUrl=queue.ref,this.deadLetterQueue=props.deadLetterQueue,this.encryptionType=encryptionType;function _determineEncryptionProps(){let encryption=props.encryption;if(encryption===queue_base_1().QueueEncryption.SQS_MANAGED&&props.encryptionMasterKey)throw new(errors_1()).ValidationError("'encryptionMasterKey' is not supported if encryption type 'SQS_MANAGED' is used",this);if(encryption!==queue_base_1().QueueEncryption.KMS&&props.encryptionMasterKey&&(encryption!==void 0&&core_1().Annotations.of(this).addWarningV2("@aws-cdk/aws-sqs:queueEncryptionChangedToKMS",[`encryption: Automatically changed to QueueEncryption.KMS, was: QueueEncryption.${Object.keys(queue_base_1().QueueEncryption)[Object.values(queue_base_1().QueueEncryption).indexOf(encryption)]}`,"When encryptionMasterKey is provided, always set `encryption: QueueEncryption.KMS`"].join(`
`)),encryption=queue_base_1().QueueEncryption.KMS),!encryption)return{encryptionProps:{},encryptionType:encryption};if(encryption===queue_base_1().QueueEncryption.UNENCRYPTED)return{encryptionType:encryption,encryptionProps:{sqsManagedSseEnabled:!1}};if(encryption===queue_base_1().QueueEncryption.KMS_MANAGED)return{encryptionType:encryption,encryptionProps:{kmsMasterKeyId:"alias/aws/sqs",kmsDataKeyReusePeriodSeconds:props.dataKeyReuse&&props.dataKeyReuse.toSeconds()}};if(encryption===queue_base_1().QueueEncryption.KMS){const masterKey=props.encryptionMasterKey||new(kms()).Key(this,"Key",{description:`Created by ${this.node.path}`});return{encryptionType:encryption,encryptionMasterKey:masterKey,encryptionProps:{kmsMasterKeyId:masterKey.keyArn,kmsDataKeyReusePeriodSeconds:props.dataKeyReuse&&props.dataKeyReuse.toSeconds()}}}if(encryption===queue_base_1().QueueEncryption.SQS_MANAGED)return{encryptionType:encryption,encryptionProps:{sqsManagedSseEnabled:!0}};throw new(errors_1()).ValidationError(`Unexpected 'encryptionType': ${encryption}`,this)}props.enforceSSL&&this.enforceSSLStatement()}determineFifoProps(props){let fifoQueue=props.fifo;const queueName=props.queueName;if(typeof fifoQueue>"u"&&queueName&&!core_1().Token.isUnresolved(queueName)&&queueName.endsWith(".fifo")&&(fifoQueue=!0),typeof fifoQueue>"u"&&props.contentBasedDeduplication&&(fifoQueue=!0),typeof fifoQueue>"u"&&props.deduplicationScope&&(fifoQueue=!0),typeof fifoQueue>"u"&&props.fifoThroughputLimit&&(fifoQueue=!0),typeof queueName=="string"){if(fifoQueue&&!queueName.endsWith(".fifo"))throw new(errors_1()).ValidationError("FIFO queue names must end in '.fifo'",this);if(!fifoQueue&&queueName.endsWith(".fifo"))throw new(errors_1()).ValidationError("Non-FIFO queue name may not end in '.fifo'",this)}if(props.contentBasedDeduplication&&!fifoQueue)throw new(errors_1()).ValidationError("Content-based deduplication can only be defined for FIFO queues",this);if(props.deduplicationScope&&!fifoQueue)throw new(errors_1()).ValidationError("Deduplication scope can only be defined for FIFO queues",this);if(props.fifoThroughputLimit&&!fifoQueue)throw new(errors_1()).ValidationError("FIFO throughput limit can only be defined for FIFO queues",this);return{contentBasedDeduplication:props.contentBasedDeduplication,deduplicationScope:props.deduplicationScope,fifoThroughputLimit:props.fifoThroughputLimit,fifoQueue:fifoQueue?!0:void 0}}enforceSSLStatement(){const statement=new(iam()).PolicyStatement({actions:["sqs:*"],conditions:{Bool:{"aws:SecureTransport":"false"}},effect:iam().Effect.DENY,resources:[this.queueArn],principals:[new(iam()).AnyPrincipal]});this.addToResourcePolicy(statement)}static{__runInitializers(_classThis,_classExtraInitializers)}};return Queue2=_classThis})();exports.Queue=Queue;
