"use strict";var __esDecorate=exports&&exports.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(f!==void 0&&typeof f!="function")throw new TypeError("Function expected");return f}for(var kind=contextIn.kind,key=kind==="getter"?"get":kind==="setter"?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),_,done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]=p==="access"?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])(kind==="accessor"?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if(kind==="accessor"){if(result===void 0)continue;if(result===null||typeof result!="object")throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&(kind==="field"?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0},__runInitializers=exports&&exports.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DatabaseInstanceReadReplica=exports.DatabaseInstanceFromSnapshot=exports.DatabaseInstance=exports.NetworkType=exports.StorageType=exports.LicenseModel=exports.DatabaseInstanceBase=void 0;var jsiiDeprecationWarnings=()=>{var tmp=require("../../.warnings.jsii.js");return jsiiDeprecationWarnings=()=>tmp,tmp};const JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti");var database_insights_mode_1=()=>{var tmp=require("./database-insights-mode");return database_insights_mode_1=()=>tmp,tmp},database_secret_1=()=>{var tmp=require("./database-secret");return database_secret_1=()=>tmp,tmp},endpoint_1=()=>{var tmp=require("./endpoint");return endpoint_1=()=>tmp,tmp},parameter_group_1=()=>{var tmp=require("./parameter-group");return parameter_group_1=()=>tmp,tmp},util_1=()=>{var tmp=require("./private/util");return util_1=()=>tmp,tmp},props_1=()=>{var tmp=require("./props");return props_1=()=>tmp,tmp},proxy_1=()=>{var tmp=require("./proxy");return proxy_1=()=>tmp,tmp},rds_generated_1=()=>{var tmp=require("./rds.generated");return rds_generated_1=()=>tmp,tmp},subnet_group_1=()=>{var tmp=require("./subnet-group");return subnet_group_1=()=>tmp,tmp},validate_database_insights_1=()=>{var tmp=require("./validate-database-insights");return validate_database_insights_1=()=>tmp,tmp},ec2=()=>{var tmp=require("../../aws-ec2");return ec2=()=>tmp,tmp},events=()=>{var tmp=require("../../aws-events");return events=()=>tmp,tmp},iam=()=>{var tmp=require("../../aws-iam");return iam=()=>tmp,tmp},logs=()=>{var tmp=require("../../aws-logs");return logs=()=>tmp,tmp},secretsmanager=()=>{var tmp=require("../../aws-secretsmanager");return secretsmanager=()=>tmp,tmp},cxschema=()=>{var tmp=require("../../cloud-assembly-schema");return cxschema=()=>tmp,tmp},core_1=()=>{var tmp=require("../../core");return core_1=()=>tmp,tmp},errors_1=()=>{var tmp=require("../../core/lib/errors");return errors_1=()=>tmp,tmp},metadata_resource_1=()=>{var tmp=require("../../core/lib/metadata-resource");return metadata_resource_1=()=>tmp,tmp},prop_injectable_1=()=>{var tmp=require("../../core/lib/prop-injectable");return prop_injectable_1=()=>tmp,tmp},cxapi=()=>{var tmp=require("../../cx-api");return cxapi=()=>tmp,tmp};class DatabaseInstanceBase extends core_1().Resource{static[JSII_RTTI_SYMBOL_1]={fqn:"aws-cdk-lib.aws_rds.DatabaseInstanceBase",version:"2.230.0"};static fromLookup(scope,id,options){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_rds_DatabaseInstanceLookupOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.fromLookup),error}const instance=core_1().ContextProvider.getValue(scope,{provider:cxschema().ContextProvider.CC_API_PROVIDER,props:{typeName:"AWS::RDS::DBInstance",exactIdentifier:options.instanceIdentifier,propertiesToReturn:["DBInstanceArn","Endpoint.Address","Endpoint.Port","DbiResourceId","DBSecurityGroups","VPCSecurityGroups"]},dummyValue:[{Identifier:"TEST",DBInstanceArn:"TESTARN","Endpoint.Address":"TESTADDRESS","Endpoint.Port":"5432",DbiResourceId:"TESTID",DBSecurityGroups:[],VPCSecurityGroups:[]}]}).value[0];let securityGroups=[];return securityGroups=(instance.DBSecurityGroups&&instance.DBSecurityGroups.length>0?instance.DBSecurityGroups:instance.VPCSecurityGroups&&instance.VPCSecurityGroups.length>0?instance.VPCSecurityGroups:[]).map(securityGroupId=>ec2().SecurityGroup.fromSecurityGroupId(scope,`LSG-${securityGroupId}`,securityGroupId)),this.fromDatabaseInstanceAttributes(scope,id,{instanceEndpointAddress:instance["Endpoint.Address"],port:Number(instance["Endpoint.Port"]),instanceIdentifier:options.instanceIdentifier,securityGroups,instanceResourceId:instance.DbiResourceId})}static fromDatabaseInstanceAttributes(scope,id,attrs){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_rds_DatabaseInstanceAttributes(attrs)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.fromDatabaseInstanceAttributes),error}class Import extends DatabaseInstanceBase{defaultPort=ec2().Port.tcp(attrs.port);connections=new(ec2()).Connections({securityGroups:attrs.securityGroups,defaultPort:this.defaultPort});instanceIdentifier=attrs.instanceIdentifier;dbInstanceEndpointAddress=attrs.instanceEndpointAddress;dbInstanceEndpointPort=core_1().Tokenization.stringifyNumber(attrs.port);instanceEndpoint=new(endpoint_1()).Endpoint(attrs.instanceEndpointAddress,attrs.port);engine=attrs.engine;enableIamAuthentication=!0;instanceResourceId=attrs.instanceResourceId}return new Import(scope,id)}addProxy(id,options){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_rds_DatabaseProxyOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.addProxy),error}return new(proxy_1()).DatabaseProxy(this,id,{proxyTarget:proxy_1().ProxyTarget.fromInstance(this),...options})}grantConnect(grantee,dbUser){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_iam_IGrantable(grantee)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.grantConnect),error}if(this.enableIamAuthentication===!1)throw new(errors_1()).ValidationError("Cannot grant connect when IAM authentication is disabled",this);if(!this.instanceResourceId)throw new(errors_1()).ValidationError("For imported Database Instances, instanceResourceId is required to grantConnect()",this);if(!dbUser)throw new(errors_1()).ValidationError("For imported Database Instances, the dbUser is required to grantConnect()",this);return this.enableIamAuthentication=!0,iam().Grant.addToPrincipal({grantee,actions:["rds-db:connect"],resourceArns:[core_1().Stack.of(this).formatArn({arnFormat:core_1().ArnFormat.COLON_RESOURCE_NAME,service:"rds-db",resource:"dbuser",resourceName:[this.instanceResourceId,dbUser].join("/")})]})}onEvent(id,options={}){try{jsiiDeprecationWarnings().aws_cdk_lib_aws_events_OnEventOptions(options)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,this.onEvent),error}const rule=new(events()).Rule(this,id,options);return rule.addEventPattern({source:["aws.rds"],resources:[this.instanceArn]}),rule.addTarget(options.target),rule}get instanceArn(){const commonAnComponents={service:"rds",resource:"db",arnFormat:core_1().ArnFormat.COLON_RESOURCE_NAME},localArn=core_1().Stack.of(this).formatArn({...commonAnComponents,resourceName:this.instanceIdentifier});return this.getResourceArnAttribute(localArn,{...commonAnComponents,resourceName:this.physicalName})}asSecretAttachmentTarget(){return{targetId:this.instanceIdentifier,targetType:secretsmanager().AttachmentTargetType.RDS_DB_INSTANCE}}}exports.DatabaseInstanceBase=DatabaseInstanceBase;var LicenseModel;(function(LicenseModel2){LicenseModel2.LICENSE_INCLUDED="license-included",LicenseModel2.BRING_YOUR_OWN_LICENSE="bring-your-own-license",LicenseModel2.GENERAL_PUBLIC_LICENSE="general-public-license"})(LicenseModel||(exports.LicenseModel=LicenseModel={}));var StorageType;(function(StorageType2){StorageType2.STANDARD="standard",StorageType2.GP2="gp2",StorageType2.GP3="gp3",StorageType2.IO1="io1",StorageType2.IO2="io2"})(StorageType||(exports.StorageType=StorageType={}));var NetworkType;(function(NetworkType2){NetworkType2.IPV4="IPV4",NetworkType2.DUAL="DUAL"})(NetworkType||(exports.NetworkType=NetworkType={}));class DatabaseInstanceNew extends DatabaseInstanceBase{vpc;connections;cloudwatchLogGroups;vpcPlacement;newCfnProps;cloudwatchLogsExports;cloudwatchLogsRetention;cloudwatchLogsRetentionRole;domainId;domainRole;enableIamAuthentication;constructor(scope,id,props){const instancePhysicalName=core_1().Token.isUnresolved(props.instanceIdentifier)?props.instanceIdentifier:props.instanceIdentifier?.toLowerCase();if(super(scope,id,{physicalName:instancePhysicalName}),this.vpc=props.vpc,props.vpcSubnets&&props.vpcPlacement)throw new(errors_1()).ValidationError("Only one of `vpcSubnets` or `vpcPlacement` can be specified",this);if(this.vpcPlacement=props.vpcSubnets??props.vpcPlacement,props.multiAz===!0&&props.availabilityZone)throw new(errors_1()).ValidationError("Requesting a specific availability zone is not valid for Multi-AZ instances",this);const subnetGroup=props.subnetGroup??new(subnet_group_1()).SubnetGroup(this,"SubnetGroup",{description:`Subnet group for ${this.node.id} database`,vpc:this.vpc,vpcSubnets:this.vpcPlacement,removalPolicy:(0,util_1().renderUnless)((0,util_1().helperRemovalPolicy)(props.removalPolicy),core_1().RemovalPolicy.DESTROY)}),securityGroups=props.securityGroups||[new(ec2()).SecurityGroup(this,"SecurityGroup",{description:`Security group for ${this.node.id} database`,vpc:props.vpc})];this.connections=new(ec2()).Connections({securityGroups,defaultPort:ec2().Port.tcp(core_1().Lazy.number({produce:()=>this.instanceEndpoint.port}))});let monitoringRole;props.monitoringInterval&&props.monitoringInterval.toSeconds()&&(monitoringRole=props.monitoringRole||new(iam()).Role(this,"MonitoringRole",{assumedBy:new(iam()).ServicePrincipal("monitoring.rds.amazonaws.com"),managedPolicies:[iam().ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonRDSEnhancedMonitoringRole")]}));const storageType=props.storageType??StorageType.GP2,iops=defaultIops(storageType,props.iops);if(props.storageThroughput&&storageType!==StorageType.GP3)throw new(errors_1()).ValidationError(`The storage throughput can only be specified with GP3 storage type. Got ${storageType}.`,this);if(storageType===StorageType.GP3&&props.storageThroughput&&iops&&!core_1().Token.isUnresolved(props.storageThroughput)&&!core_1().Token.isUnresolved(iops)&&props.storageThroughput/iops>.25)throw new(errors_1()).ValidationError(`The maximum ratio of storage throughput to IOPS is 0.25. Got ${props.storageThroughput/iops}.`,this);this.cloudwatchLogGroups={},this.cloudwatchLogsExports=props.cloudwatchLogsExports,this.cloudwatchLogsRetention=props.cloudwatchLogsRetention,this.cloudwatchLogsRetentionRole=props.cloudwatchLogsRetentionRole,this.enableIamAuthentication=props.iamAuthentication;const enablePerformanceInsights=props.enablePerformanceInsights||props.performanceInsightRetention!==void 0||props.performanceInsightEncryptionKey!==void 0||props.databaseInsightsMode===database_insights_mode_1().DatabaseInsightsMode.ADVANCED;props.domain&&(this.domainId=props.domain,this.domainRole=props.domainRole||new(iam()).Role(this,"RDSDirectoryServiceRole",{assumedBy:new(iam()).CompositePrincipal(new(iam()).ServicePrincipal("rds.amazonaws.com"),new(iam()).ServicePrincipal("directoryservice.rds.amazonaws.com")),managedPolicies:[iam().ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonRDSDirectoryServiceAccess")]}));const maybeLowercasedInstanceId=core_1().FeatureFlags.of(this).isEnabled(cxapi().RDS_LOWERCASE_DB_IDENTIFIER)&&!core_1().Token.isUnresolved(props.instanceIdentifier)?props.instanceIdentifier?.toLowerCase():props.instanceIdentifier,instanceParameterGroupConfig=props.parameterGroup?.bindToInstance({}),isInPublicSubnet=this.vpcPlacement&&this.vpcPlacement.subnetType===ec2().SubnetType.PUBLIC;this.newCfnProps={autoMinorVersionUpgrade:props.autoMinorVersionUpgrade,availabilityZone:props.multiAz?void 0:props.availabilityZone,backupRetentionPeriod:props.backupRetention?.toDays(),copyTagsToSnapshot:props.copyTagsToSnapshot??!0,dbInstanceClass:core_1().Lazy.string({produce:()=>`db.${this.instanceType}`}),dbInstanceIdentifier:core_1().Token.isUnresolved(props.instanceIdentifier)?this.physicalName:maybeLowercasedInstanceId,dbSubnetGroupName:subnetGroup.subnetGroupName,deleteAutomatedBackups:props.deleteAutomatedBackups,deletionProtection:(0,util_1().defaultDeletionProtection)(props.deletionProtection,props.removalPolicy),enableCloudwatchLogsExports:this.cloudwatchLogsExports,enableIamDatabaseAuthentication:core_1().Lazy.any({produce:()=>this.enableIamAuthentication}),enablePerformanceInsights:enablePerformanceInsights||props.enablePerformanceInsights,iops,monitoringInterval:props.monitoringInterval?.toSeconds(),monitoringRoleArn:monitoringRole?.roleRef.roleArn,multiAz:props.multiAz,dbParameterGroupName:instanceParameterGroupConfig?.parameterGroupName,optionGroupName:props.optionGroup?.optionGroupName,performanceInsightsKmsKeyId:props.performanceInsightEncryptionKey?.keyRef.keyArn,performanceInsightsRetentionPeriod:enablePerformanceInsights?props.performanceInsightRetention||props_1().PerformanceInsightRetention.DEFAULT:void 0,databaseInsightsMode:props.databaseInsightsMode,port:props.port!==void 0?core_1().Tokenization.stringifyNumber(props.port):void 0,preferredBackupWindow:props.preferredBackupWindow,preferredMaintenanceWindow:props.preferredMaintenanceWindow,processorFeatures:props.processorFeatures&&renderProcessorFeatures(props.processorFeatures),publiclyAccessible:props.publiclyAccessible??isInPublicSubnet,storageType,storageThroughput:props.storageThroughput,vpcSecurityGroups:securityGroups.map(s=>s.securityGroupId),maxAllocatedStorage:props.maxAllocatedStorage,domain:this.domainId,domainIamRoleName:this.domainRole?.roleRef.roleName,networkType:props.networkType,caCertificateIdentifier:props.caCertificate?props.caCertificate.toString():void 0,applyImmediately:props.applyImmediately,engineLifecycleSupport:props.engineLifecycleSupport}}setLogRetention(){if(this.cloudwatchLogsExports&&this.cloudwatchLogsRetention)for(const log of this.cloudwatchLogsExports){const logGroupName=`/aws/rds/instance/${this.instanceIdentifier}/${log}`;new(logs()).LogRetention(this,`LogRetention${log}`,{logGroupName,retention:this.cloudwatchLogsRetention,role:this.cloudwatchLogsRetentionRole}),this.cloudwatchLogGroups[log]=logs().LogGroup.fromLogGroupName(this,`LogGroup${this.instanceIdentifier}${log}`,logGroupName)}}}class DatabaseInstanceSource extends DatabaseInstanceNew{engine;sourceCfnProps;instanceType;singleUserRotationApplication;multiUserRotationApplication;constructor(scope,id,props){super(scope,id,props),this.singleUserRotationApplication=props.engine.singleUserRotationApplication,this.multiUserRotationApplication=props.engine.multiUserRotationApplication,this.engine=props.engine;const engineType=props.engine.engineType;if(props.engineLifecycleSupport&&!["mysql","postgres"].includes(engineType))throw new(errors_1()).ValidationError(`'engineLifecycleSupport' can only be specified for RDS for MySQL and RDS for PostgreSQL, got: '${engineType}'`,this);const combineRoles=engineType.startsWith("oracle-")||engineType.startsWith("sqlserver-");let{s3ImportRole,s3ExportRole}=(0,util_1().setupS3ImportExport)(this,props,combineRoles);const engineConfig=props.engine.bindToInstance(this,{...props,s3ImportRole,s3ExportRole}),instanceAssociatedRoles=[],engineFeatures=engineConfig.features;if(s3ImportRole){if(!engineFeatures?.s3Import)throw new(errors_1()).ValidationError(`Engine '${(0,util_1().engineDescription)(props.engine)}' does not support S3 import`,this);instanceAssociatedRoles.push({roleArn:s3ImportRole.roleArn,featureName:engineFeatures?.s3Import})}if(s3ExportRole){if(!engineFeatures?.s3Export)throw new(errors_1()).ValidationError(`Engine '${(0,util_1().engineDescription)(props.engine)}' does not support S3 export`,this);engineFeatures.s3Import!==engineFeatures?.s3Export&&instanceAssociatedRoles.push({roleArn:s3ExportRole.roleArn,featureName:engineFeatures?.s3Export})}if(this.instanceType=props.instanceType??ec2().InstanceType.of(ec2().InstanceClass.M5,ec2().InstanceSize.LARGE),props.parameterGroup&&props.parameters)throw new(errors_1()).ValidationError("You cannot specify both parameterGroup and parameters",this);const dbParameterGroupName=props.parameters?new(parameter_group_1()).ParameterGroup(this,"ParameterGroup",{engine:props.engine,parameters:props.parameters}).bindToInstance({}).parameterGroupName:this.newCfnProps.dbParameterGroupName;this.sourceCfnProps={...this.newCfnProps,associatedRoles:instanceAssociatedRoles.length>0?instanceAssociatedRoles:void 0,optionGroupName:engineConfig.optionGroup?.optionGroupName,allocatedStorage:props.allocatedStorage?.toString()??"100",allowMajorVersionUpgrade:props.allowMajorVersionUpgrade,dbName:props.databaseName,engine:engineType,engineVersion:props.engine.engineVersion?.fullVersion,licenseModel:props.licenseModel,timezone:props.timezone,dbParameterGroupName}}addRotationSingleUser(options={}){if(!this.secret)throw new(errors_1()).ValidationError("Cannot add single user rotation for an instance without secret.",this);const id="RotationSingleUser";if(this.node.tryFindChild(id))throw new(errors_1()).ValidationError("A single user rotation was already added to this instance.",this);return new(secretsmanager()).SecretRotation(this,id,{...(0,util_1().applyDefaultRotationOptions)(options,this.vpcPlacement),secret:this.secret,application:this.singleUserRotationApplication,vpc:this.vpc,target:this})}addRotationMultiUser(id,options){if(!this.secret)throw new(errors_1()).ValidationError("Cannot add multi user rotation for an instance without secret.",this);return new(secretsmanager()).SecretRotation(this,id,{...(0,util_1().applyDefaultRotationOptions)(options,this.vpcPlacement),secret:options.secret,masterSecret:this.secret,application:this.multiUserRotationApplication,vpc:this.vpc,target:this})}grantConnect(grantee,dbUser){if(!dbUser){if(!this.secret)throw new(errors_1()).ValidationError("A secret or dbUser is required to grantConnect()",this);dbUser=this.secret.secretValueFromJson("username").unsafeUnwrap()}return super.grantConnect(grantee,dbUser)}}let DatabaseInstance=(()=>{let _classDecorators=[prop_injectable_1().propertyInjectable],_classDescriptor,_classExtraInitializers=[],_classThis,_classSuper=DatabaseInstanceSource;var DatabaseInstance2=class extends _classSuper{static{_classThis=this}static{const _metadata=typeof Symbol=="function"&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;__esDecorate(null,_classDescriptor={value:_classThis},_classDecorators,{kind:"class",name:_classThis.name,metadata:_metadata},null,_classExtraInitializers),DatabaseInstance2=_classThis=_classDescriptor.value,_metadata&&Object.defineProperty(_classThis,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static[JSII_RTTI_SYMBOL_1]={fqn:"aws-cdk-lib.aws_rds.DatabaseInstance",version:"2.230.0"};static PROPERTY_INJECTION_ID="aws-cdk-lib.aws-rds.DatabaseInstance";instanceIdentifier;dbInstanceEndpointAddress;dbInstanceEndpointPort;instanceResourceId;instanceEndpoint;secret;constructor(scope,id,props){super(scope,id,props);try{jsiiDeprecationWarnings().aws_cdk_lib_aws_rds_DatabaseInstanceProps(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,DatabaseInstance2),error}(0,metadata_resource_1().addConstructMetadata)(this,props),(0,validate_database_insights_1().validateDatabaseInstanceProps)(this,props);const credentials=(0,util_1().renderCredentials)(this,props.engine,props.credentials),secret=credentials.secret,instance=new(rds_generated_1()).CfnDBInstance(this,"Resource",{...this.sourceCfnProps,characterSetName:props.characterSetName,kmsKeyId:props.storageEncryptionKey&&props.storageEncryptionKey.keyRef.keyArn,masterUsername:credentials.username,masterUserPassword:credentials.password?.unsafeUnwrap(),storageEncrypted:props.storageEncryptionKey?!0:props.storageEncrypted});this.instanceIdentifier=this.getResourceNameAttribute(instance.ref),this.dbInstanceEndpointAddress=instance.attrEndpointAddress,this.dbInstanceEndpointPort=instance.attrEndpointPort,this.instanceResourceId=instance.attrDbiResourceId;const portAttribute=core_1().Token.asNumber(instance.attrEndpointPort);this.instanceEndpoint=new(endpoint_1()).Endpoint(instance.attrEndpointAddress,portAttribute),instance.applyRemovalPolicy(props.removalPolicy??core_1().RemovalPolicy.SNAPSHOT),secret&&(this.secret=secret.attach(this)),this.setLogRetention()}static{__runInitializers(_classThis,_classExtraInitializers)}};return DatabaseInstance2=_classThis})();exports.DatabaseInstance=DatabaseInstance;let DatabaseInstanceFromSnapshot=(()=>{let _classDecorators=[prop_injectable_1().propertyInjectable],_classDescriptor,_classExtraInitializers=[],_classThis,_classSuper=DatabaseInstanceSource;var DatabaseInstanceFromSnapshot2=class extends _classSuper{static{_classThis=this}static{const _metadata=typeof Symbol=="function"&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;__esDecorate(null,_classDescriptor={value:_classThis},_classDecorators,{kind:"class",name:_classThis.name,metadata:_metadata},null,_classExtraInitializers),DatabaseInstanceFromSnapshot2=_classThis=_classDescriptor.value,_metadata&&Object.defineProperty(_classThis,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static[JSII_RTTI_SYMBOL_1]={fqn:"aws-cdk-lib.aws_rds.DatabaseInstanceFromSnapshot",version:"2.230.0"};static PROPERTY_INJECTION_ID="aws-cdk-lib.aws-rds.DatabaseInstanceFromSnapshot";instanceIdentifier;dbInstanceEndpointAddress;dbInstanceEndpointPort;instanceResourceId;instanceEndpoint;secret;constructor(scope,id,props){super(scope,id,props);try{jsiiDeprecationWarnings().aws_cdk_lib_aws_rds_DatabaseInstanceFromSnapshotProps(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,DatabaseInstanceFromSnapshot2),error}if((0,metadata_resource_1().addConstructMetadata)(this,props),!props.snapshotIdentifier&&!props.clusterSnapshotIdentifier)throw new(errors_1()).ValidationError("You must specify `snapshotIdentifier` or `clusterSnapshotIdentifier`",this);if(props.snapshotIdentifier&&props.clusterSnapshotIdentifier)throw new(errors_1()).ValidationError("You cannot specify both `snapshotIdentifier` and `clusterSnapshotIdentifier`",this);let credentials=props.credentials,secret=credentials?.secret;if(!secret&&credentials?.generatePassword){if(!credentials.username)throw new(errors_1()).ValidationError("`credentials` `username` must be specified when `generatePassword` is set to true",this);secret=new(database_secret_1()).DatabaseSecret(this,"Secret",{username:credentials.username,encryptionKey:credentials.encryptionKey,excludeCharacters:credentials.excludeCharacters,replaceOnPasswordCriteriaChanges:credentials.replaceOnPasswordCriteriaChanges,replicaRegions:credentials.replicaRegions})}const instance=new(rds_generated_1()).CfnDBInstance(this,"Resource",{...this.sourceCfnProps,dbSnapshotIdentifier:props.snapshotIdentifier,dbClusterSnapshotIdentifier:props.clusterSnapshotIdentifier,masterUserPassword:secret?.secretValueFromJson("password")?.unsafeUnwrap()??credentials?.password?.unsafeUnwrap()});this.instanceIdentifier=instance.ref,this.dbInstanceEndpointAddress=instance.attrEndpointAddress,this.dbInstanceEndpointPort=instance.attrEndpointPort,this.instanceResourceId=instance.attrDbiResourceId;const portAttribute=core_1().Token.asNumber(instance.attrEndpointPort);this.instanceEndpoint=new(endpoint_1()).Endpoint(instance.attrEndpointAddress,portAttribute),instance.applyRemovalPolicy(props.removalPolicy??core_1().RemovalPolicy.SNAPSHOT),secret&&(this.secret=secret.attach(this)),this.setLogRetention()}static{__runInitializers(_classThis,_classExtraInitializers)}};return DatabaseInstanceFromSnapshot2=_classThis})();exports.DatabaseInstanceFromSnapshot=DatabaseInstanceFromSnapshot;let DatabaseInstanceReadReplica=(()=>{let _classDecorators=[prop_injectable_1().propertyInjectable],_classDescriptor,_classExtraInitializers=[],_classThis,_classSuper=DatabaseInstanceNew;var DatabaseInstanceReadReplica2=class extends _classSuper{static{_classThis=this}static{const _metadata=typeof Symbol=="function"&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;__esDecorate(null,_classDescriptor={value:_classThis},_classDecorators,{kind:"class",name:_classThis.name,metadata:_metadata},null,_classExtraInitializers),DatabaseInstanceReadReplica2=_classThis=_classDescriptor.value,_metadata&&Object.defineProperty(_classThis,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static[JSII_RTTI_SYMBOL_1]={fqn:"aws-cdk-lib.aws_rds.DatabaseInstanceReadReplica",version:"2.230.0"};static PROPERTY_INJECTION_ID="aws-cdk-lib.aws-rds.DatabaseInstanceReadReplica";instanceIdentifier;dbInstanceEndpointAddress;dbInstanceEndpointPort;instanceResourceId;instanceEndpoint;engine=void 0;instanceType;constructor(scope,id,props){super(scope,id,props);try{jsiiDeprecationWarnings().aws_cdk_lib_aws_rds_DatabaseInstanceReadReplicaProps(props)}catch(error){throw process.env.JSII_DEBUG!=="1"&&error.name==="DeprecationError"&&Error.captureStackTrace(error,DatabaseInstanceReadReplica2),error}if((0,metadata_resource_1().addConstructMetadata)(this,props),props.sourceDatabaseInstance.engine&&!props.sourceDatabaseInstance.engine.supportsReadReplicaBackups&&props.backupRetention)throw new(errors_1()).ValidationError(`Cannot set 'backupRetention', as engine '${(0,util_1().engineDescription)(props.sourceDatabaseInstance.engine)}' does not support automatic backups for read replicas`,this);const engineType=props.sourceDatabaseInstance.engine?.engineType;if(engineType&&props.engineLifecycleSupport&&!["mysql","postgres"].includes(engineType))throw new(errors_1()).ValidationError(`'engineLifecycleSupport' can only be specified for RDS for MySQL and RDS for PostgreSQL, got: '${engineType}'`,this);const shouldPassEngine=props.domain!=null,instance=new(rds_generated_1()).CfnDBInstance(this,"Resource",{...this.newCfnProps,sourceDbInstanceIdentifier:props.sourceDatabaseInstance.instanceArn,kmsKeyId:props.storageEncryptionKey?.keyRef.keyArn,storageEncrypted:props.storageEncryptionKey?!0:props.storageEncrypted,engine:shouldPassEngine?engineType:void 0,allocatedStorage:props.allocatedStorage?.toString()});this.instanceType=props.instanceType,this.instanceIdentifier=instance.ref,this.dbInstanceEndpointAddress=instance.attrEndpointAddress,this.dbInstanceEndpointPort=instance.attrEndpointPort,this.instanceResourceId=core_1().FeatureFlags.of(this).isEnabled(cxapi().USE_CORRECT_VALUE_FOR_INSTANCE_RESOURCE_ID_PROPERTY)?instance.attrDbiResourceId:instance.attrDbInstanceArn;const portAttribute=core_1().Token.asNumber(instance.attrEndpointPort);this.instanceEndpoint=new(endpoint_1()).Endpoint(instance.attrEndpointAddress,portAttribute),instance.applyRemovalPolicy(props.removalPolicy??core_1().RemovalPolicy.SNAPSHOT),this.setLogRetention()}static{__runInitializers(_classThis,_classExtraInitializers)}};return DatabaseInstanceReadReplica2=_classThis})();exports.DatabaseInstanceReadReplica=DatabaseInstanceReadReplica;function renderProcessorFeatures(features){const featuresList=Object.entries(features).map(([name,value])=>({name,value:value.toString()}));return featuresList.length===0?void 0:featuresList}function defaultIops(storageType,iops){switch(storageType){case StorageType.STANDARD:case StorageType.GP2:return;case StorageType.GP3:return iops;case StorageType.IO1:case StorageType.IO2:return iops??1e3}}
